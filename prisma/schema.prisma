generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum MatchConfidence {
  EXACT
  HIGH
  MEDIUM
  LOW
  UNMATCHED
}

enum ComparisonStatus {
  MATCH
  OVERCHARGE
  UNDERCHARGE
  UNMATCHED
}

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  name          String?
  passwordHash  String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  catalogues    Catalogue[]
  receipts      Receipt[]
}

model Catalogue {
  id               String           @id @default(cuid())
  userId           String
  name             String
  originalFileName String
  fileUrl          String?
  language         String           @default("tr")
  status           ProcessingStatus @default(PENDING)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items            CatalogueItem[]
  reports          ComparisonReport[]
  
  @@index([userId])
}

model CatalogueItem {
  id          String    @id @default(cuid())
  catalogueId String
  productName String
  sku         String?
  unit        String?
  price       Decimal   @db.Decimal(12, 2)
  category    String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  catalogue   Catalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  comparisonItems ComparisonItem[]
  
  @@index([catalogueId])
  @@index([productName])
}

model Receipt {
  id               String           @id @default(cuid())
  userId           String
  supplierName     String?
  originalFileName String
  fileUrl          String?
  receiptDate      DateTime?
  totalAmount      Decimal?         @db.Decimal(12, 2)
  language         String           @default("tr")
  status           ProcessingStatus @default(PENDING)
  createdAt        DateTime         @default(now())
  
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items            ReceiptItem[]
  reports          ComparisonReport[]
  
  @@index([userId])
}

model ReceiptItem {
  id          String   @id @default(cuid())
  receiptId   String
  productName String
  rawText     String?
  quantity    Decimal  @db.Decimal(12, 3)
  unit        String?
  unitPrice   Decimal  @db.Decimal(12, 2)
  totalPrice  Decimal  @db.Decimal(12, 2)
  lineNumber  Int
  
  receipt     Receipt  @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  comparisonItems ComparisonItem[]
  
  @@index([receiptId])
}

model ComparisonReport {
  id              String   @id @default(cuid())
  receiptId       String
  catalogueId     String
  totalItems      Int
  matchedItems    Int
  mismatches      Int
  totalOvercharge Decimal  @db.Decimal(12, 2) @default(0)
  totalUndercharge Decimal @db.Decimal(12, 2) @default(0)
  createdAt       DateTime @default(now())
  
  receipt         Receipt  @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  catalogue       Catalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  items           ComparisonItem[]
  
  @@index([receiptId])
  @@index([catalogueId])
}

model ComparisonItem {
  id              String           @id @default(cuid())
  reportId        String
  receiptItemId   String
  catalogueItemId String?
  receiptPrice    Decimal          @db.Decimal(12, 2)
  cataloguePrice  Decimal?         @db.Decimal(12, 2)
  priceDifference Decimal?         @db.Decimal(12, 2)
  percentageDiff  Decimal?         @db.Decimal(8, 2)
  matchConfidence MatchConfidence  @default(UNMATCHED)
  status          ComparisonStatus @default(UNMATCHED)
  
  report          ComparisonReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  receiptItem     ReceiptItem      @relation(fields: [receiptItemId], references: [id], onDelete: Cascade)
  catalogueItem   CatalogueItem?   @relation(fields: [catalogueItemId], references: [id], onDelete: SetNull)
  
  @@index([reportId])
}
