generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum MatchConfidence {
  EXACT
  HIGH
  MEDIUM
  LOW
  UNMATCHED
}

enum ComparisonStatus {
  MATCH
  OVERCHARGE
  UNDERCHARGE
  UNMATCHED
}

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  name          String?
  passwordHash  String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  catalogues    Catalogue[]
  invoices      Invoice[]
}

model Catalogue {
  id               String           @id @default(cuid())
  userId           String
  name             String
  originalFileName String
  fileUrl          String?
  language         String           @default("tr")
  currency         String           @default("GBP") // ISO currency code
  status           ProcessingStatus @default(PENDING)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items            CatalogueItem[]
  reports          ComparisonReport[]
  invoices         InvoiceCatalogue[] // Invoices linked to this catalogue
  
  @@index([userId])
}

model CatalogueItem {
  id          String    @id @default(cuid())
  catalogueId String
  productName String
  sku         String?
  unit        String?
  price       Decimal   @db.Decimal(12, 2)
  category    String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  catalogue       Catalogue       @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  comparisonItems ComparisonItem[]
  invoiceItems    InvoiceItem[]   // Invoice items linked to this catalogue item
  
  @@index([catalogueId])
  @@index([productName])
}

model Invoice {
  id               String           @id @default(cuid())
  userId           String
  supplierName     String?
  originalFileName String
  fileUrl          String?
  invoiceDate      DateTime?
  totalAmount      Decimal?         @db.Decimal(12, 2)
  language         String           @default("tr")
  currency         String           @default("USD") // ISO currency code
  status           ProcessingStatus @default(PENDING)
  createdAt        DateTime         @default(now())
  
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items            InvoiceItem[]
  reports          ComparisonReport[]
  catalogues       InvoiceCatalogue[] // Linked catalogues for this invoice
  
  @@index([userId])
}

// Join table for Invoice-Catalogue many-to-many relationship
model InvoiceCatalogue {
  id          String    @id @default(cuid())
  invoiceId   String
  catalogueId String
  createdAt   DateTime  @default(now())
  
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  catalogue   Catalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  
  @@unique([invoiceId, catalogueId])
  @@index([invoiceId])
  @@index([catalogueId])
}

model InvoiceItem {
  id              String         @id @default(cuid())
  invoiceId       String
  catalogueItemId String?        // Direct link to catalogue item
  productName     String
  rawText         String?
  quantity        Decimal        @db.Decimal(12, 3)
  unit            String?
  unitPrice       Decimal        @db.Decimal(12, 2)
  totalPrice      Decimal        @db.Decimal(12, 2)
  lineNumber      Int
  
  invoice         Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  catalogueItem   CatalogueItem? @relation(fields: [catalogueItemId], references: [id], onDelete: SetNull)
  comparisonItems ComparisonItem[]
  
  @@index([invoiceId])
  @@index([catalogueItemId])
}

model ComparisonReport {
  id               String   @id @default(cuid())
  invoiceId        String
  catalogueId      String
  totalItems       Int
  matchedItems     Int
  mismatches       Int
  totalOvercharge  Decimal  @db.Decimal(12, 2) @default(0)
  totalUndercharge Decimal  @db.Decimal(12, 2) @default(0)
  invoiceCurrency  String   @default("USD") // Currency of the invoice
  catalogueCurrency String  @default("GBP") // Currency of the catalogue
  exchangeRate     Decimal? @db.Decimal(10, 6) // Exchange rate used for comparison
  createdAt        DateTime @default(now())
  
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  catalogue       Catalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  items           ComparisonItem[]
  
  @@index([invoiceId])
  @@index([catalogueId])
}

model ComparisonItem {
  id                    String           @id @default(cuid())
  reportId              String
  invoiceItemId         String
  catalogueItemId       String?
  invoicePrice          Decimal          @db.Decimal(12, 2) // Original price in invoice currency
  invoicePriceConverted Decimal?         @db.Decimal(12, 2) // Converted to catalogue currency
  cataloguePrice        Decimal?         @db.Decimal(12, 2) // Price in catalogue currency
  priceDifference       Decimal?         @db.Decimal(12, 2) // Difference after conversion
  percentageDiff        Decimal?         @db.Decimal(8, 2)
  exchangeRate          Decimal?         @db.Decimal(10, 6) // Exchange rate used
  matchConfidence       MatchConfidence  @default(UNMATCHED)
  status                ComparisonStatus @default(UNMATCHED)
  
  report          ComparisonReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  invoiceItem     InvoiceItem      @relation(fields: [invoiceItemId], references: [id], onDelete: Cascade)
  catalogueItem   CatalogueItem?   @relation(fields: [catalogueItemId], references: [id], onDelete: SetNull)
  
  @@index([reportId])
}
